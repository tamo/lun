<!DOCTYPE html>
<html lang="ja">
	<head>
		<title>lun - fun learning tool for students</title>
		<meta name="viewport" content="width=device-width,initial-scale=1.0" />
		<style>
			html {
				color: black;
				background-color: white;
			}
			p {
				font-size: 130%;
			}
			.tab {
				border: outset white;
				color: blue;
				text-decoration: none;
			}
			button {
				font-size: 200%;
			}
			#toggleButton {
				display: block;
				width: 100%;
			}
			#speakButton {
				width: 45%;
			}
			progress {
				width: 45%;
			}
			#progressSpan {
				position: relative;
			}
			#current {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
			}
			#answerDiv {
				opacity: 1;
				transition: all 1s ease-in-out 0s;
			}
			.collapse {
				opacity: 0 !important;
			}
			#nextButton {
				width: 100%;
			}
			#helpDiv * {
				display: inline-block;
			}
			strong {
				font-size: 140%;
			}
			.pulse {
				animation: pulse 2s infinite;
			}
			@keyframes pulse {
				0% {
					transform: scale(0.95);
					box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.7);
				}
				70% {
					transform: scale(1);
					box-shadow: 0 0 0 10px rgba(0, 0, 0, 0);
				}
				100% {
					transform: scale(0.95);
					box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
				}
			}
		</style>
	</head>
	<body>
		<p>
			<a class="tab" href="#snishi-2-202212">西2</a>
			<a class="tab" href="#taihei-1-202212">太1</a>
			<a class="tab" href="#3-pp-146-147">中3教146</a>
			<a class="tab" href="#hjswords">中基礎</a>
		</p>
		<div id="quizDiv">
			<p>勉強するんですね！ 始めましょう！</p>
		</div>
		<button id="nextButton" class="collapse">⏭️</button>
		<button id="stopButton" class="collapse">⏹️</button>
		<div id="helpDiv">
			<button id="helpButton" class="pulse">❔</button>
			<div id="helpMessage" class="collapse">
				最初は、上のボタンで範囲を選んでください。<br />
				問題文をタップすると答えを表示できます。(終わりにも一覧できます)<br />
				🔊でヒントとして音声を出せます。(2回目以降徐々に遅くなります)<br />
				⏭️で次の問題に進みます。(途中で終わりたいなら⏹️)
			</div>
		</div>
		<script>
			const helpDiv = document.getElementById("helpDiv");
			helpDiv.addEventListener("click", function (e) {
				const helpMessage = document.getElementById("helpMessage");
				helpMessage.classList.toggle("collapse");
			});

			window.onload = loadHash;
			window.onhashchange = loadHash;
			function loadHash(e) {
				// reset tabs anyways
				const tabs = [...document.getElementsByClassName("tab")];
				tabs.forEach(function (tab) {
					tab.style.borderStyle = "outset";
					tab.style.color = "blue";
				});

				const hash = window.location.hash;
				// includes the beginning #
				if (!hash || !/^#[-A-Za-z0-9]+$/.test(hash)) {
					console.log("hash is null or invalid", window.location);
					return;
				}
				const target = document.querySelector('a[href$="' + hash + '"]');
				if (!target) {
					console.error("anchor not found", hash);
					return;
				}
				const fileName = target.href.split("#").pop();
				if (fileName) {
					target.style.borderStyle = "inset";
					target.style.color = "grey";
					start("./" + fileName + ".txt");
				}
			}

			function start(url) {
				if (!url) return;

				// refresh the buttons
				const helpButton = document.getElementById("helpButton");
				helpButton.classList.remove("pulse");
				// cannot be const because they will be replaced
				let nextButton = document.getElementById("nextButton");
				let stopButton = document.getElementById("stopButton");
				nextButton = cleanButton(nextButton);
				stopButton = cleanButton(stopButton);

				// could be replaced with fetch
				const xhr = new XMLHttpRequest();
				xhr.open("GET", url, true);
				xhr.onload = onLoadListener.bind(xhr, url);
				xhr.send(null);

				// clone without listeners
				function cleanButton(button) {
					const cloned = button.cloneNode(true);
					button.parentNode.replaceChild(cloned, button);
					return cloned;
				}

				function onLoadListener(_url) {
					if (this.readyState != 4 || this.status != 200) return;

					// "a1|q1\na2|q2" -> [["a1", "q1"], ["a2", "q2"]]
					const quizPairs = [];
					const lines = this.responseText.split("\n");
					lines.forEach(function (line) {
						const pair = line.split("|");
						if (pair.length == 2) {
							quizPairs.push(pair);
						} else {
							if (line.length > 0) console.log("[not a pair] " + line);
						}
					});
					// Fisher-Yates
					(function shuffle(array) {
						let i = array.length;
						while (1 < i--) {
							const j = Math.floor(Math.random() * (i + 1));
							[array[i], array[j]] = [array[j], array[i]];
						}
					})(quizPairs);
					// quizPairs.length will decrease later
					const progressMax = quizPairs.length;
					const results = [];

					// buttons have no listeners yet
					nextButton.addEventListener("click", nextListener);
					nextButton.classList.remove("collapse");
					stopButton.addEventListener("click", stopListener);
					stopButton.classList.remove("collapse");

					// start!
					nextListener();

					function nextListener(e) {
						nextButton.classList.remove("pulse");

						if (quizPairs.length > 0) {
							const currentPair = quizPairs.pop();
							results.push(currentPair[1] + " = " + currentPair[0]);

							// progressbar and quiz
							const current = progressMax - quizPairs.length;
							const quizDiv = document.getElementById("quizDiv");
							quizDiv.innerHTML =
								`<button id='toggleButton'>${currentPair[1]}</button>` +
								"<button id='speakButton'>🔊</button>" +
								"<span id='progressSpan'>" +
								` <progress max=${progressMax} value=${current}></progress>` +
								` <span id='current'>${current}/${progressMax}</span>` +
								"</span>" +
								`<p id='answerDiv' class='collapse'>${currentPair[0]}</p>`;

							// toggle speech
							const speakButton = document.getElementById("speakButton");
							speakButton.addEventListener("click", function (e) {
								if (window.speechSynthesis.speaking) {
									if (window.speechSynthesis.paused) {
										window.speechSynthesis.resume();
									} else {
										window.speechSynthesis.pause();
									}
									return;
								}

								const speakRate =
									parseFloat(this.getAttribute("speakRate")) || 1.0;
								const u = new SpeechSynthesisUtterance();
								u.lang = "en-US";
								u.text = currentPair[0];
								u.rate = speakRate;
								u.onstart = pauseEmoji;
								u.onpause = startEmoji;
								u.onresume = pauseEmoji;
								u.onend = startEmoji;
								window.speechSynthesis.speak(u);
								// slower next time
								this.setAttribute("speakRate", speakRate * 0.6);
								results.push("🔊" + results.pop());

								function pauseEmoji() {
									speakButton.innerText = "🔇";
								}
								function startEmoji() {
									speakButton.innerText = "🔊";
								}
							});

							// toggle answer
							const toggleButton = document.getElementById("toggleButton");
							toggleButton.addEventListener("click", function (e) {
								this.classList.remove("pulse");
								const answerDiv = document.getElementById("answerDiv");
								answerDiv.classList.toggle("collapse");
								nextButton.classList.add("pulse");
								results.push("<strong>" + results.pop() + "</strong>");
							});
							toggleButton.classList.add("pulse");
						} else {
							// result
							const quizDiv = document.getElementById("quizDiv");
							quizDiv.innerHTML =
								`<p>🎉 ${results.length}/${progressMax}</p>` +
								"<div>" +
								results.join("<br />") +
								"</div>";

							// hide stopButton
							stopButton.classList.add("collapse");
							stopButton.removeEventListener("click", stopListener);

							// nextButton to restart
							nextButton.removeEventListener("click", nextListener);
							nextButton.addEventListener("click", retryListener);
						}

						function retryListener(e) {
							nextButton.removeEventListener("click", retryListener);
							start(_url);
						}
					}
					function stopListener(e) {
						while (quizPairs.pop()); // empty
						nextListener(); // result
					}
				}
			}
		</script>
	</body>
</html>
