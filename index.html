<!DOCTYPE html>
<html lang="ja">
	<head>
		<title>lun - fun learning tool for students</title>
		<meta name="viewport" content="width=device-width,initial-scale=1.0" />
		<style>
			html {
				color: black;
				background-color: white;
			}
			p {
				font-size: 130%;
			}
			.tab {
				border: outset white;
				color: blue;
				text-decoration: none;
			}
			button {
				font-size: 200%;
			}
			#q_txt {
				display: block;
				width: 100%;
			}
			#a_pron {
				width: 45%;
			}
			progress {
				width: 45%;
			}
			#progressbar {
				position: relative;
			}
			#pos {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
			}
			#a_txt {
				opacity: 1;
				transition: all 1s ease-in-out 0s;
			}
			.collapse {
				opacity: 0 !important;
			}
			#next {
				width: 100%;
			}
			#helpdiv * {
				display: inline-block;
			}
			strong {
				font-size: 140%;
			}
			.pulse {
				animation: pulse 2s infinite;
			}
			@keyframes pulse {
				0% {
					transform: scale(0.95);
					box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.7);
				}
				70% {
					transform: scale(1);
					box-shadow: 0 0 0 10px rgba(0, 0, 0, 0);
				}
				100% {
					transform: scale(0.95);
					box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
				}
			}
		</style>
	</head>
	<body>
		<p>
			<a class="tab" href="#snishi-2-202212">西2</a>
			<a class="tab" href="#taihei-1-202212">太1</a>
			<a class="tab" href="#3-pp-146-147">中3教146</a>
			<a class="tab" href="#hjswords">中基礎</a>
		</p>
		<p id="q">勉強するんですね！ 始めましょう！</p>
		<button id="next" class="collapse">⏭️</button>
		<button id="stop" class="collapse">⏹️</button>
		<div id="helpdiv">
			<button id="helpbtn" class="pulse">❔</button>
			<div id="helptxt" class="collapse">
				最初は、上のボタンで範囲を選んでください。<br />
				問題文をタップすると答えを表示できます。(終わりにも一覧できます)<br />
				🔊でヒントとして音声を出せます。(2回目以降徐々に遅くなります)<br />
				⏭️で次の問題に進みます。(途中で終わりたいなら⏹️)
			</div>
		</div>
		<script>
			const helpdiv = document.getElementById("helpdiv");
			helpdiv.addEventListener("click", function (e) {
				const helptxt = document.getElementById("helptxt");
				helptxt.classList.toggle("collapse");
			});

			window.onload = loadhash;
			window.onhashchange = loadhash;
			function loadhash(e) {
				const hash = window.location.hash;
				// includes the beginning #
				if (!hash || !/^#[-A-Za-z0-9]+$/.test(hash)) {
					console.log("hash is null or invalid", window.location);
					return;
				}
				const target = document.querySelector('a[href$="' + hash + '"]');
				if (!target) {
					console.error("anchor not found", hash);
					return;
				}
				const tabs = [...document.getElementsByClassName("tab")];
				tabs.forEach(function (tab) {
					tab.style.borderStyle = "outset";
					tab.style.color = "blue";
				});
				const filefromhash = target.href.split("#").pop();
				if (filefromhash) {
					target.style.borderStyle = "inset";
					target.style.color = "grey";
					start("./" + filefromhash + ".txt");
				}
			}
			function start(filename) {
				if (!filename) return;
				// refresh the buttons
				const helpbtn = document.getElementById("helpbtn");
				helpbtn.classList.remove("pulse");
				// cannot be const because they will be replaced
				let nextbtn = document.getElementById("next");
				let stopbtn = document.getElementById("stop");
				nextbtn = cleanbtn(nextbtn);
				stopbtn = cleanbtn(stopbtn);
				// could be replaced with fetch
				const xhr = new XMLHttpRequest();
				xhr.open("GET", filename, true);
				xhr.onload = procdata.bind(xhr, filename);
				xhr.send(null);
				return;
				// clone without listeners
				function cleanbtn(btn) {
					const newbtn = btn.cloneNode(true);
					btn.parentNode.replaceChild(newbtn, btn);
					return newbtn;
				}
				function procdata(filename) {
					if (this.readyState != 4 || this.status != 200) return;
					// "a1|q1\na2|q2" -> [["a1", "q1"], ["a2", "q2"]]
					const qa = [];
					const lines = this.responseText.split("\n");
					lines.forEach(function (line) {
						const pair = line.split("|");
						if (pair.length == 2) {
							qa.push(pair);
						} else {
							if (line.length > 0) console.log("[not a qa] " + line);
						}
					});
					// Fisher-Yates
					(function shuffle(array) {
						let i = array.length;
						while (1 < i--) {
							const j = Math.floor(Math.random() * (i + 1));
							[array[i], array[j]] = [array[j], array[i]];
						}
					})(qa);
					// qa.length will decrease later
					const totalnum = qa.length;
					const results = [];
					// buttons have no listeners yet
					nextbtn.addEventListener("click", nextListener);
					nextbtn.classList.remove("collapse");
					stopbtn.addEventListener("click", stopListener);
					stopbtn.classList.remove("collapse");
					// start!
					nextListener();
					return;
					function nextListener(e) {
						nextbtn.classList.remove("pulse");
						if (qa.length > 0) {
							const q_array = qa.pop();
							results.push(q_array[1] + " = " + q_array[0]);
							// progressbar and quiz
							const pos = totalnum - qa.length;
							const q = document.getElementById("q");
							q.innerHTML =
								`<button id='q_txt'>${q_array[1]}</button>` +
								"<button id='a_pron'>🔊</button>" +
								"<span id='progressbar'>" +
								` <progress max=${totalnum} value=${pos}></progress>` +
								` <span id='pos'>${pos}/${totalnum}</span>` +
								"</span>" +
								`<p id='a_txt' class='collapse'>${q_array[0]}</p>`;
							// speech button
							const a_pron = document.getElementById("a_pron");
							a_pron.addEventListener("click", function (e) {
								const a_pron_rate =
									parseFloat(this.getAttribute("pronrate")) || 1.0;
								const u = new SpeechSynthesisUtterance();
								u.lang = "en-US";
								u.text = q_array[0];
								u.rate = a_pron_rate;
								speechSynthesis.speak(u);
								// gradually slower
								this.setAttribute("pronrate", a_pron_rate * 0.6);
								results.push("🔊" + results.pop());
							});
							// toggle answer
							const q_txt = document.getElementById("q_txt");
							q_txt.addEventListener("click", function (e) {
								this.classList.remove("pulse");
								const a_txt = document.getElementById("a_txt");
								a_txt.classList.toggle("collapse");
								nextbtn.classList.add("pulse");
								results.push("<strong>" + results.pop() + "</strong>");
							});
							q_txt.classList.add("pulse");
						} else {
							// result
							const q = document.getElementById("q");
							q.innerHTML =
								`<p>🎉 ${results.length}/${totalnum}</p>` +
								"<div>" +
								results.join("<br />") +
								"</div>";
							// hide stopbtn
							stopbtn.classList.add("collapse");
							stopbtn.removeEventListener("click", stopListener);
							// nextbtn to restart
							nextbtn.removeEventListener("click", nextListener);
							nextbtn.addEventListener("click", retryListener);
						}
						return;
						function retryListener (e) {
							nextbtn.removeEventListener("click", retryListener);
							start(filename);
						}
					}
					function stopListener(e) {
						while (qa.pop()); // empty
						nextListener(); // result
					}
				}
			}
		</script>
	</body>
</html>
